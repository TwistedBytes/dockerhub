- pipeline: "Dockerhub builds centos8-php80"
  on: "CLICK"
  refs:
    - "refs/heads/main"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
    - action: "Lint Dockerfile"
      type: "DOCKERFILE_LINTER"
      local_path: "${dockerdir}/Dockerfile"
      shell_type: "sh"
    - action: "Get Image version"
      type: "BUILD"
      working_directory: "/buddy/dockerhub"
      docker_image_name: "library/centos"
      docker_image_tag: "8"
      execute_commands:
        - "IMAGE_VERSION=`grep org.opencontainers.image.version ${dockerdir}/Dockerfile | awk -F \\\" '{print $2}'`"
      volume_mappings:
        - "/:/buddy/dockerhub"
      cache_base_image: true
      shell: "BASH"
    - action: "Build Docker image"
      type: "DOCKERFILE"
      docker_image_tag: "latest,${IMAGE_VERSION}"
      dockerfile_path: "${dockerdir}/Dockerfile"
      context_path: "${dockerdir}"
      repository: "twistedbytes/${dockerdir}"
      build_args:
        - "IMAGE_CREATED=${BUDDY_EXECUTION_START_DATE}"
      trigger_conditions:
        - trigger_condition: "ON_CHANGE_AT_PATH"
          trigger_condition_paths:
            - "${dockerdir}/"
      target_platform: "linux/amd64"
      integration_hash: "9JOyLkQWjneg8XjlawZ1p0GDXN"
    - action: "Clear cache"
      type: "CLEAR_CACHE"
      cache_types:
        - "DOCKER"
        - "FILE_SYSTEM"
        - "SERVICES"
        - "ADDITIONAL"
        - "DOCKER_CLI"
  variables:
    - key: "IMAGE_VERSION"
      value: "2022.01.13.01"
      type: "VAR"
      settable: true
    - key: "dockerdir"
      value: "centos8-php80"
      type: "VAR"
      settable: true

- pipeline: "Dockerhub builds centos8-php81"
  on: "CLICK"
  refs:
    - "refs/heads/main"
  priority: "NORMAL"
  fail_on_prepare_env_warning: true
  actions:
    - action: "Lint Dockerfile"
      type: "DOCKERFILE_LINTER"
      local_path: "${dockerdir}/Dockerfile"
      shell_type: "sh"
    - action: "Get Image version"
      type: "BUILD"
      working_directory: "/buddy/dockerhub"
      docker_image_name: "library/centos"
      docker_image_tag: "8"
      execute_commands:
        - "IMAGE_VERSION=`grep org.opencontainers.image.version ${dockerdir}/Dockerfile | awk -F \\\" '{print $2}'`"
      volume_mappings:
        - "/:/buddy/dockerhub"
      cache_base_image: true
      shell: "BASH"
    - action: "Build Docker image"
      type: "DOCKERFILE"
      docker_image_tag: "latest,${IMAGE_VERSION}"
      dockerfile_path: "${dockerdir}/Dockerfile"
      context_path: "${dockerdir}"
      repository: "twistedbytes/${dockerdir}"
      build_args:
        - "IMAGE_CREATED=${BUDDY_EXECUTION_START_DATE}"
      trigger_conditions:
        - trigger_condition: "ON_CHANGE_AT_PATH"
          trigger_condition_paths:
            - "${dockerdir}/"
      target_platform: "linux/amd64"
      integration_hash: "9JOyLkQWjneg8XjlawZ1p0GDXN"
    - action: "Clear cache"
      type: "CLEAR_CACHE"
      cache_types:
        - "DOCKER"
        - "FILE_SYSTEM"
        - "SERVICES"
        - "ADDITIONAL"
        - "DOCKER_CLI"
  variables:
    - key: "IMAGE_VERSION"
      value: "2022.01.13.01"
      type: "VAR"
      settable: true
    - key: "dockerdir"
      value: "centos8-php81"
      type: "VAR"
      settable: true
